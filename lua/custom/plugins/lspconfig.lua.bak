-- NOTE: Tried to make basedpyright work without having to install it in the local
--      pipenv package or use venv-selector, without success. Gave up for now and will use venv-selector.
return {
  {
    'neovim/nvim-lspconfig',
    config = function()
      local lspconfig = require 'lspconfig'
      local util = lspconfig.util

      lspconfig.basedpyright.setup {
        on_new_config = function(new_config, root_dir)
          local util = require('lspconfig').util

          local pipfile_dir = util.search_ancestors(root_dir, function(path)
            return util.path.is_file(util.path.join(path, 'Pipfile'))
          end)

          if not pipfile_dir then
            return
          end

          new_config.cmd = {
            'sh',
            '-c',
            'cd ' .. vim.fn.shellescape(pipfile_dir) .. ' && pipenv run basedpyright-langserver --stdio',
          }
          -- new_config.cmd = {
          --   'pipenv',
          --   'run',
          --   'basedpyright-langserver',
          --   '--stdio',
          -- }

          -- local result = vim.system({ 'pipenv', '--venv' }, { cwd = pipfile_dir, text = true }):wait()
          --
          -- if result.code ~= 0 then
          --   return
          -- end
          --
          -- local python = result.stdout:gsub('%s+', '') .. '/bin/python'
          --
          -- new_config.settings = new_config.settings or {}
          -- new_config.settings.python = new_config.settings.python or {}
          -- new_config.settings.python.pythonPath = python
        end,
      }
    end,
  },
}

-- return{
-- require("lspconfig").basedpyright.setup({
--       on_attach = on_attach,
--       capabilities = capabilities,
--       on_new_config = function(new_config, dir)
--         if require("util").dir_has_file(dir, "Pipfile") then
--           vim.notify_once("Running `basedpyright` with `pipenv`")
--           new_config.cmd = { "pipenv", "run", "basedpyright-langserver", "--stdio" }
--         else
--           vim.notify_once("Running `basedpyright` without a virtualenv")
--         end
--       end,
--     })
-- }
